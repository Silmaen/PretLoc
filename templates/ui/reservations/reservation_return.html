{% extends 'base.html' %}
{% load i18n %}
{% load l10n %}

{% block content %}
    <div class="auth-container" style="max-width: 900px;">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-arrow-left auth-icon" style="color: var(--accent-blue);"></i>
                <h2>{% trans "Retour de matériel" %}</h2>
            </div>

            <!-- En-tête avec informations de la réservation -->
            <div class="reservation-header" style="margin-bottom: 20px;">
                <div class="reservation-customer-info">
                    <h3>{{ reservation.customer }}</h3>
                    <p>
                        <i class="fas fa-envelope"></i> {{ reservation.customer.email }}
                        {% if reservation.customer.phone %}
                            | <i class="fas fa-phone"></i> {{ reservation.customer.phone }}
                        {% endif %}
                    </p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        <i class="fas fa-arrow-right"></i> {{ reservation.checkout_date }} |
                        <i class="fas fa-arrow-left"></i> {{ reservation.return_date }}
                    </p>
                </div>
            </div>

            <!-- Date de retour réelle -->
            <div class="auth-card" style="margin-bottom: 20px;">
                <h4 class="no-margin-title">
                    <i class="fas fa-calendar-alt"></i> {% trans "Date de retour" %}
                </h4>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="actual_return_date">
                        {% trans "Date de retour réelle" %}
                    </label>
                    <div class="flatpickr-wrapper">
                        <input type="text" id="actual_return_date" name="actual_return_date"
                               placeholder="{% trans 'Sélectionner une date' %}"
                               value="{% now 'Y-m-d H:i' %}"
                               class="datepicker" data-input>
                        <a class="input-button" data-toggle title="{% trans 'Sélectionner une date' %}">
                            <i class="fas fa-calendar-alt"></i>
                        </a>
                    </div>
                </div>
            </div>

            <form method="post" id="return-form">
                {% csrf_token %}
                <input type="hidden" id="actual_return_date_input" name="actual_return_date">

                <!-- Articles à retourner -->
                <div class="auth-card" style="margin-bottom: 20px;">
                    <h4 class="no-margin-title">
                        <i class="fas fa-boxes"></i> {% trans "Articles à retourner" %}
                    </h4>

                    <table>
                        <thead>
                        <tr>
                            <th>{% trans "Article" %}</th>
                            <th style="width: 80px; text-align: center;">{% trans "Sortis" %}</th>
                            <th style="width: 90px; text-align: center;">{% trans "Rendus OK" %}</th>
                            <th style="width: 90px; text-align: center;">{% trans "Abîmés" %}</th>
                            <th style="width: 90px; text-align: center;">{% trans "Détruits" %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in items %}
                            <tr>
                                <td>
                                    <strong>{{ item.asset.name }}</strong><br>
                                    <small style="color: var(--text-secondary);">{{ item.asset.category.name }}</small>
                                </td>
                                <td style="text-align: center;">
                                    <strong>{{ item.quantity_checked_out }}</strong>
                                </td>
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="return_{{ item.id }}"
                                           class="quantity-input return-quantity"
                                           data-item-id="{{ item.id }}"
                                           data-max="{{ item.quantity_checked_out }}"
                                           value="{{ item.quantity_checked_out }}"
                                           min="0"
                                           max="{{ item.quantity_checked_out }}">
                                </td>
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="damaged_{{ item.id }}"
                                           class="quantity-input return-quantity"
                                           data-item-id="{{ item.id }}"
                                           data-max="{{ item.quantity_checked_out }}"
                                           value="0"
                                           min="0"
                                           max="{{ item.quantity_checked_out }}">
                                </td>
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="destroyed_{{ item.id }}"
                                           class="quantity-input return-quantity"
                                           data-item-id="{{ item.id }}"
                                           data-max="{{ item.quantity_checked_out }}"
                                           value="0"
                                           min="0"
                                           max="{{ item.quantity_checked_out }}">
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    <div class="form-help-text" style="margin-top: 15px;">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Le total pour chaque ligne doit correspondre à la quantité sortie" %}
                    </div>
                </div>

                <!-- Calcul des dons -->
                <div class="auth-card" style="margin-bottom: 20px;">
                    <h4 class="no-margin-title">
                        <i class="fas fa-calculator"></i> {% trans "Calcul des dons" %}
                    </h4>

                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-box-open"></i>
                            {% trans "Articles empruntés" %}
                        </div>
                        <div class="detail-value">
                            <strong id="expected-donation">{{ total_expected|floatformat:2 }} €</strong>
                        </div>
                    </div>
                    {% if not customer_membership %}
                        <div class="detail-row">
                            <div class="detail-label">
                                <i class="fas fa-user-check"></i>
                                {% trans "Cotisation annuelle" %}
                            </div>
                            <div class="detail-value">
                                <strong>{{ customer_membership_fee|floatformat:2 }} €</strong>
                            </div>
                        </div>
                    {% endif %}
                    {% if not reservation.customer.donation_exempted and reservation.customer.get_donation_coefficient != 1 %}
                        <div class="detail-row">
                            <div class="detail-label">
                                <i class="fas fa-percentage"></i>
                                {% trans "Coefficient client" %}:
                            </div>
                            <div class="detail-value">
                                <strong>{{ reservation.customer.get_donation_coefficient|floatformat:2 }}</strong>
                            </div>
                        </div>
                    {% endif %}
                    <div class="detail-row" id="repair-row">
                        <div class="detail-label">
                            <i class="fas fa-tools"></i>
                            {% trans "Réparation" %}
                        </div>
                        <div class="detail-value">
                            <strong id="repair-donation">0 €</strong>
                        </div>
                    </div>

                    <div class="detail-row-accentued">
                        <div class="detail-label" style="font-size: 1.1em;">
                            <i class="fas fa-coins"></i>
                            {% trans "Total à collecter" %}
                        </div>
                        <div class="detail-value-accentued">
                            <span id="total-donation">{{ total_expected }} €</span>
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-hand-holding-heart"></i>
                            {% trans "Don effectué" %}
                        </div>
                        <div class="detail-value">
                            <input type="number"
                                   name="total_donations"
                                   id="total_donations"
                                   class="quantity-input"
                                   step="1.00"
                                   min="0"
                                   value="{{ total_expected|floatformat:2 }}">
                        </div>
                    </div>

                    <div class="form-help-text" style="margin-top: 10px;">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Ajustez le montant du don selon le retour effectif" %}
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="reservation-footer-actions">
                    <a href="javascript:history.back()" class="auth-button secondary">
                        <i class="fas fa-times"></i> {% trans "Annuler" %}
                    </a>
                    <button type="submit" class="auth-button">
                        <i class="fas fa-check"></i> {% trans "Valider le retour" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {% include "includes/flatpickr_script.html" %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const coefficient = parseFloat('{{ reservation.customer.get_donation_coefficient }}');
            const isExempted = {{ reservation.customer.donation_exempted|lower }};
            const hasMembership = {{ customer_membership|lower }};
            const membershipFee = {{ customer_membership_fee|unlocalize }};

            const items = [
                {% for item in items %}
                    {
                        id: {{ item.id }},
                        rentalValue: parseFloat('{{ item.asset.rental_value }}'),
                        replacementValue: parseFloat('{{ item.asset.replacement_value }}'),
                        checkedOut: {{ item.quantity_checked_out }}
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            function updateTotals() {
                let theoreticalTotal = 0;
                let damagedTotal = 0;

                items.forEach(item => {
                    const maxQty = item.checkedOut;
                    const returnedInput = document.querySelector(`input[name="return_${item.id}"]`);
                    const damagedInput = document.querySelector(`input[name="damaged_${item.id}"]`);
                    const destroyedInput = document.querySelector(`input[name="destroyed_${item.id}"]`);

                    if (returnedInput && damagedInput && destroyedInput) {
                        let returnedQty = parseInt(returnedInput.value) || 0;
                        let damagedQty = parseInt(damagedInput.value) || 0;
                        const destroyedQty = parseInt(destroyedInput.value) || 0;

                        // Calculer le total basé sur tous les items (y compris endommagés et détruits)
                        const total_returned = returnedQty + damagedQty + destroyedQty;
                        if (total_returned > maxQty) {
                            // Si la somme dépasse la quantité sortie, réinitialiser les champs
                            if (damagedQty > maxQty - destroyedQty) {
                                damagedInput.value = maxQty - destroyedQty;
                                damagedQty = maxQty - destroyedQty;
                            }
                            if (returnedQty > maxQty - damagedQty - destroyedQty) {
                                returnedInput.value = maxQty - damagedQty - destroyedQty;
                                returnedQty = maxQty - damagedQty - destroyedQty;
                            }
                        }
                        let total_damaged = maxQty - returnedQty;
                        if (total_damaged > 0) {
                            damagedTotal += total_damaged * item.replacementValue;
                        }
                        theoreticalTotal += maxQty * item.rentalValue;
                    }
                });
                if (damagedTotal > 0) {
                    document.getElementById('repair-row').style.display = 'flex';
                    document.getElementById('repair-donation').textContent = damagedTotal.toFixed(2) + ' €';
                } else {
                    document.getElementById('repair-row').style.display = 'none';
                    document.getElementById('repair-donation').textContent = '0 €';
                }


                if (!isExempted) {
                    theoreticalTotal = theoreticalTotal * coefficient;
                }

                expectedTotal = damagedTotal + theoreticalTotal;
                // Ajouter la cotisation si non payée
                if (!hasMembership) {
                    expectedTotal += membershipFee;
                }

                document.getElementById('expected-donation').textContent = theoreticalTotal.toFixed(2) + ' €';
                document.getElementById('total-donation').textContent = expectedTotal.toFixed(2) + ' €';
            }

            // Écouter les changements sur tous les champs de quantité
            const quantityInputs = document.querySelectorAll('input[name^="return_"], input[name^="damaged_"], input[name^="destroyed_"]');
            quantityInputs.forEach(input => {
                input.addEventListener('input', updateTotals);
                input.addEventListener('change', updateTotals);
            });

            // Initialiser au chargement
            updateTotals();
        });
    </script>
{% endblock %}
