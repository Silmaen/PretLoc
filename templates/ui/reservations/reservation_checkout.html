{% extends 'base.html' %}
{% load i18n %}
{% load l10n %}

{% block content %}
    <div class="auth-container" style="max-width: 800px;">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-arrow-right auth-icon" style="color: var(--accent-blue);"></i>
                <h2>{% trans "Sortie de matériel" %}</h2>
            </div>

            <!-- En-tête avec informations de la réservation -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <h3 style="margin: 0;">{{ reservation.customer }}</h3>
                    <div>
                    <span style="font-weight: bold; font-size: 0.9rem;">
                        <i class="fas fa-arrow-right"></i> {{ reservation.checkout_date }} | 
                        <i class="fas fa-arrow-left"></i> {{ reservation.return_date }}
                    </span>
                    </div>
                </div>
                <div style="font-size: 0.9rem;">
                    <i class="fas fa-envelope"></i> {{ reservation.customer.email }}
                    {% if reservation.customer.phone %}
                        | <i class="fas fa-phone"></i> {{ reservation.customer.phone }}
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="actual_checkout_date">
                        <i class="fas fa-calendar-alt"></i> {% trans "Date de sortie réelle" %}
                    </label>
                    <div class="flatpickr-wrapper">
                        <input type="text" id="actual_checkout_date" name="actual_checkout_date"
                               placeholder="{% trans 'Sélectionner une date' %}"
                               value="{% now 'Y-m-d H:M' %}"
                               class="datepicker" data-input>
                        <a class="input-button" data-toggle title="{% trans 'Sélectionner une date' %}">
                            <i class="fas fa-calendar-alt"></i>
                        </a>
                    </div>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}

                <!-- Articles à sortir -->
                <div class="auth-card" style="margin-top: 20px;">
                    <h4 class="no-margin-title">
                        <i class="fas fa-boxes"></i> {% trans "Articles à sortir" %}
                    </h4>

                    <table>
                        <thead>
                        <tr>
                            <th>{% trans "Article" %}</th>
                            <th style="width: 100px; text-align: center;">{% trans "Réservé" %}</th>
                            <th style="text-align: center;">{% trans "Disponible" %}</th>
                            <th style="width: 100px; text-align: center;">{% trans "À sortir" %}</th>
                            <th style="text-align: right;">{% trans "Don unitaire" %}</th>
                            <th style="width: 150px; text-align: right;">{% trans "Don total" %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in items %}
                            <tr>
                                <td>
                                    <strong>{{ item.asset.name }}</strong><br>
                                    <small style="color: var(--text-secondary);">{{ item.asset.category.name }}</small>
                                </td>
                                <td style="text-align: center;">{{ item.quantity_reserved }}</td>
                                <td style="text-align: center;">
                                    {% if item.asset.stock_quantity < item.quantity_reserved %}
                                        <span class="quantity-warning">{{ item.asset.stock_quantity }}</span>
                                    {% else %}
                                        {{ item.asset.stock_quantity }}
                                    {% endif %}
                                </td>
                                <td style="text-align: center;">
                                    <input type="number"
                                           name="checkout_{{ item.id }}"
                                           class="quantity-input"
                                           data-item-id="{{ item.id }}"
                                           data-unit-price="{{ item.asset.rental_value }}"
                                           value="{{ item.quantity_reserved }}"
                                           min="0"
                                           max="{{ item.asset.stock_quantity }}">
                                </td>
                                <td style="text-align: right;">{{ item.asset.rental_value }} €</td>
                                <td style="text-align: right;">
                                    <span class="item-total" data-item-id="{{ item.id }}">
                                        {{ item.expected_donation }} €
                                    </span>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Don minimum attendu (en lecture seule) -->
                <div class="auth-card" style="margin-top: 20px;">
                    <h4 class="no-margin-title">
                        <i class="fas fa-euro-sign"></i> {% trans "Totaux" %}
                    </h4>

                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-hand-holding-usd"></i>
                            {% trans "Don attendu (articles)" %}
                        </div>
                        <div class="detail-value">
                            <strong id="expected-donation">{{ total_expected }}</strong>
                        </div>
                    </div>

                    {% if not customer_membership %}
                        <div class="detail-row">
                            <div class="detail-label">
                                <i class="fas fa-id-card"></i>
                                {% trans "Cotisation annuelle" %}
                            </div>
                            <div class="detail-value">
                                <strong>{{ customer_membership_fee }}</strong> €
                                <span style="color: var(--accent-red);">({% trans "Non payée" %})</span>
                            </div>
                        </div>
                    {% else %}
                        <div class="detail-row">
                            <div class="detail-label">
                                <i class="fas fa-check-circle"></i>
                                {% trans "Cotisation annuelle" %}
                            </div>
                            <div class="detail-value">
                                <span style="color: var(--accent-blue);">({% trans "Déjà payée" %})</span>
                            </div>
                        </div>
                    {% endif %}
                    {% if not reservation.customer.donation_exempted and reservation.customer.get_donation_coefficient != 1 %}
                        <div class="detail-row">
                            <div class="detail-label">
                                <i class="fas fa-percent"></i>
                                {% trans "Coefficient client" %}:
                            </div>
                            <div class="detail-value">
                                <strong>{{ reservation.customer.get_donation_coefficient|floatformat:2 }}</strong>
                            </div>
                        </div>
                    {% endif %}

                    <div class="detail-row" style="border-top: 2px solid var(--accent-blue); padding-top: 15px;">
                        <div class="detail-label">
                            <i class="fas fa-coins"></i>
                            {% trans "Total à collecter" %}
                        </div>
                        <div class="detail-value">
                            <strong id="total-donation" style="font-size: 1.2em; color: var(--accent-blue);">
                                {% if customer_membership %}
                                    {{ total_expected }}
                                {% else %}
                                    {% widthratio total_expected 1 1 as total_with_membership %}
                                    {% widthratio customer_membership_fee 1 1 as membership_decimal %}
                                    {{ total_expected|add:customer_membership_fee }}
                                {% endif %}
                            </strong> €
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="auth-card" style="margin-top: 20px;">
                    <label for="notes">
                        <i class="fas fa-sticky-note"></i> {% trans "Notes" %}
                    </label>
                    <textarea class="dark-textarea" id="notes" name="notes" rows="3">{{ reservation.notes }}</textarea>
                    <div class="form-help-text">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Ajoutez des remarques ou informations complémentaires" %}
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <a href="javascript:history.back()" class="auth-button"
                       style="background-color: var(--bg-element);">
                        <i class="fas fa-times"></i> {% trans "Annuler" %}
                    </a>
                    <button type="submit" class="auth-button">
                        <i class="fas fa-arrow-right"></i> {% trans "Valider la sortie" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {% include "includes/flatpickr_script.html" %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const coefficient = parseFloat('{{ reservation.customer.get_donation_coefficient }}');
            const items = [
                {% for item in items %}
                    {
                        id: {{ item.id }},
                        rentalValue: parseFloat('{{ item.asset.rental_value }}')
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            function updateTotals() {
                let theoreticalTotal = 0;

                items.forEach(item => {
                    const input = document.querySelector(`input[name="checkout_${item.id}"]`);
                    if (input) {
                        const quantity = parseInt(input.value) || 0;
                        theoreticalTotal += quantity * item.rentalValue;
                    }
                });

                let expectedTotal = theoreticalTotal * coefficient;
                const hasMembership = {{ customer_membership|lower }};
                const membershipFee = {{ customer_membership_fee|unlocalize }};
                if (!hasMembership) {
                    expectedTotal += membershipFee;
                }

                document.getElementById('expected-donation').textContent = theoreticalTotal.toFixed(2) + ' €';
                document.getElementById('total-donation').textContent = expectedTotal.toFixed(2) + ' €';
            }

            // Écouter les changements sur tous les champs de quantité
            const quantityInputs = document.querySelectorAll('input[name^="checkout_"]');
            quantityInputs.forEach(input => {
                input.addEventListener('input', updateTotals);
                input.addEventListener('change', updateTotals);
            });

            // Initialiser au chargement
            updateTotals();
        });
    </script>
{% endblock %}