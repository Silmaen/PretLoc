{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'css/select2.css' %}">
{% endblock %}

{% block content %}
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-hand-holding-heart auth-icon"></i>
                <h2>{% trans "Gestion des dons" %}</h2>
            </div>

            <!-- Search & action button on the same line -->
            <div class="search-action-bar">
                <form method="get" class="search-container">
                    <select id="id_customer" name="customer"></select>
                    <button type="submit" class="auth-button search-button">
                        <i class="fas fa-search"></i> {% trans "Rechercher" %}
                    </button>
                </form>
                <div class="actions-buttons">
                    {% if capability.can_add_donations %}
                        <a href="{% url 'ui:donation_create' %}" class="auth-button"
                           title="{% trans "Nouveau don" %}">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Filter list -->
            <div class="filters-row">
                <div class="filter-group">
                    <span class="filter-label">
                        <i class="fas fa-id-card"></i>
                        {% trans "Adhésion" %}
                    </span>
                    <div class="filter-buttons-container">
                        <a href="?search={{ search_query }}&sort={{ sort }}"
                           class="filter-button {% if not includes_membership %}active{% endif %}">
                            {% trans "Toutes" %}
                        </a>
                        <a href="?search={{ search_query }}&includes_membership=true&sort={{ sort }}"
                           class="filter-button {% if includes_membership == 'true' %}active{% endif %}">
                            {% trans "Avec adhésion" %}
                        </a>
                        <a href="?search={{ search_query }}&includes_membership=false&sort={{ sort }}"
                           class="filter-button {% if includes_membership == 'false' %}active{% endif %}">
                            {% trans "Sans adhésion" %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="auth-card-secondary">
                <div class="flex-between">
                    <span>
                        <i class="fas fa-list"></i>
                        <strong>{{ donations.count }}</strong> {% trans "don(s)" %}
                    </span>
                    <span class="auth-blue" style="font-size: 1.2rem; font-weight: bold;">
                        <i class="fas fa-euro-sign"></i> {{ total_donations|floatformat:2 }} €
                    </span>
                </div>
            </div>

            <!-- Donation list -->
            <div class="users-table">
                <table>
                    <thead>
                    <tr>
                        <th>
                            {% trans "Date" %}
                            <div class="sort-buttons">
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if includes_membership %}includes_membership={{ includes_membership }}&{% endif %}sort=date&direction=asc"
                                   class="sort-btn {% if sort == 'date' and direction == 'asc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down"></i>
                                </a>
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if includes_membership %}includes_membership={{ includes_membership }}&{% endif %}sort=date&direction=desc"
                                   class="sort-btn {% if sort == 'date' and direction == 'desc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down-alt"></i>
                                </a>
                            </div>
                        </th>
                        <th>
                            {% trans "Client" %}
                            <div class="sort-buttons">
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if includes_membership %}includes_membership={{ includes_membership }}&{% endif %}sort=customer&direction=asc"
                                   class="sort-btn {% if sort == 'customer' and direction == 'asc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down"></i>
                                </a>
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if includes_membership %}includes_membership={{ includes_membership }}&{% endif %}sort=customer&direction=desc"
                                   class="sort-btn {% if sort == 'customer' and direction == 'desc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down-alt"></i>
                                </a>
                            </div>
                        </th>
                        <th>
                            {% trans "Montant" %}
                            <div class="sort-buttons">
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if includes_membership %}includes_membership={{ includes_membership }}&{% endif %}sort=amount&direction=asc"
                                   class="sort-btn {% if sort == 'amount' and direction == 'asc' %}active{% endif %}">
                                    <i class="fas fa-sort-numeric-down"></i>
                                </a>
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if includes_membership %}includes_membership={{ includes_membership }}&{% endif %}sort=amount&direction=desc"
                                   class="sort-btn {% if sort == 'amount' and direction == 'desc' %}active{% endif %}">
                                    <i class="fas fa-sort-numeric-down-alt"></i>
                                </a>
                            </div>
                        </th>
                        <th>{% trans "Adhésion" %}</th>
                        <th>{% trans "Réservation" %}</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for donation in donations %}
                        <tr>
                            <td>{{ donation.date|date:"d/m/Y" }}</td>
                            <td>
                                <div class="item-info">
                                    <a href="{% url 'ui:customer_detail' donation.customer.pk %}" class="auth-blue">
                                        <i class="fas fa-user"></i>
                                        <span class="item-title">{{ donation.customer }}</span>
                                    </a>
                                </div>
                            </td>
                            <td class="auth-blue">
                                {{ donation.amount|floatformat:2 }} €
                            </td>
                            <td class="table-cell-center">
                                {% if donation.includes_membership %}
                                    <i class="fas fa-check-circle donation-value good"></i>
                                {% else %}
                                    <i class="fas fa-times-circle donation-value bad"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if donation.reservation %}
                                    <a href="{% url 'ui:reservation_detail' donation.reservation.pk %}"
                                       class="auth-blue">
                                        <i class="fas fa-link"></i>
                                        Rés. #{{ donation.reservation.pk }}
                                    </a>
                                {% else %}
                                    <span>
                                        <i class="fas fa-minus"></i> {% trans "Aucune" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="actions-buttons">
                                    <a href="{% url 'ui:donation_update' donation.pk %}" class="action-button">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'ui:donation_delete' donation.pk %}" class="action-button danger">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">
                                <i class="fas fa-inbox table-empty-logo"></i>
                                <p class="table-empty-text">
                                    {% trans "Aucun don trouvé" %}
                                </p>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        {% get_current_language as CURRENT_LANGUAGE %}
        let currentLang = "{{ CURRENT_LANGUAGE }}";
        if (currentLang === 'en') {
            currentLang = "en-GB"
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'js/select2_customer.js' %}"></script>

    <script>
        $(document).ready(function () {
            initCustomerSelect2('#id_customer', {
                searchUrl: "{% url 'ui:search_customers' %}",
                placeholder: "{% trans 'Rechercher un client...' %}",
                language: currentLang,
                exemptedTitle: "{% trans 'Exonéré de don' %}",
                {% if donation and donation.customer %}
                    initialCustomer: {
                        id: {{ donation.customer.id }},
                        text: "{{ donation.customer }}",
                        icon: "{{ donation.customer.customer_type.icon }}",
                        color: "{{ donation.customer.customer_type.color }}",
                        exempted: {{ donation.customer.is_exempted_from_donation|yesno:"true,false" }},
                        type_name: "{{ donation.customer.customer_type.name }}"
                    }
                {% endif %}
            });
        });
    </script>

{% endblock %}