{% extends 'base.html' %}
{% load i18n %}

{% block content %}
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-user auth-icon"></i>
                <h2>{% trans "Détails du Client" %}</h2>
            </div>

            <!-- Informations du client -->
            <div class="auth-card-secondary">
                <h4>{% trans "Informations générales" %}</h4>
                <div class="detail-row">
                    <div class="detail-label">
                        <i class="fas fa-users"></i> {% trans "Type de client" %}
                    </div>
                    <div class="detail-value">
                        <span style="color: {{ customer.customer_type.color }}">
                            <i class="{% if customer.customer_type.entity_type == 'physical' %}fas fa-user{% else %}fas fa-building{% endif %}"></i>
                            {{ customer.customer_type.name }}
                        </span>
                    </div>
                </div>

                {% if customer.customer_type.entity_type == "physical" %}
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-user"></i> {% trans "Nom" %}
                        </div>
                        <div class="detail-value">
                            {{ customer.last_name }} {{ customer.first_name }}
                        </div>
                    </div>
                {% else %}
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-building"></i> {% trans "Raison sociale" %}
                        </div>
                        <div class="detail-value">
                            {{ customer.company_name }}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-user-tie"></i> {% trans "Représentant légal" %}
                        </div>
                        <div class="detail-value">
                            {{ customer.legal_rep_last_name }} {{ customer.legal_rep_first_name }}
                        </div>
                    </div>
                {% endif %}

                <div class="detail-row">
                    <div class="detail-label">
                        <i class="fas fa-envelope"></i> {% trans "Email" %}
                    </div>
                    <div class="detail-value">
                        <a href="mailto:{{ customer.email }}" class="email-link">{{ customer.email }}</a>
                    </div>
                </div>

                {% if customer.phone %}
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-phone"></i> {% trans "Téléphone" %}
                        </div>
                        <div class="detail-value">
                            {{ customer.phone }}
                        </div>
                    </div>
                {% endif %}

                <div class="detail-row">
                    <div class="detail-label">
                        <i class="fas fa-map-marker-alt"></i> {% trans "Adresse" %}
                    </div>
                    <div class="detail-value">
                        {{ customer.address }}
                    </div>
                </div>

                {% if customer.is_exempted_from_donation %}
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-hand-holding-usd"></i> {% trans "Exonération" %}
                        </div>
                        <div class="detail-value">
                            <span class="badge-exemption">
                                <i class="fas fa-check-circle"></i> {% trans "Exonéré de don" %}
                            </span>
                        </div>
                    </div>
                {% else %}
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-percent"></i> {% trans "Coefficient de don" %}
                        </div>
                        <div class="detail-value">
                            {{ customer.get_donation_coefficient }}
                        </div>
                    </div>
                {% endif %}

                {% if customer.notes %}
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-sticky-note"></i> {% trans "Notes" %}
                        </div>
                        <div class="detail-value">
                            <div class="notes-display">{{ customer.notes }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Statistiques -->
            <div class="auth-card-secondary">
                <h4>{% trans "Statistiques" %}</h4>
                <div class="detail-row">
                    <div class="detail-label">
                        <i class="fas fa-hand-holding-heart"></i> {% trans "Total des dons" %}
                    </div>
                    <div class="detail-value">{{ total_donations|floatformat:2 }} €</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">
                        <i class="fas fa-calendar-check"></i> {% trans "Nombre de réservations" %}
                    </div>
                    <div class="detail-value">{{ total_reservations }}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">
                        <i class="fas fa-id-card"></i> {% trans "Cotisation" %}
                    </div>
                    <div class="detail-value">
                        {% if is_membership_up_to_date %}
                            <span style="color: var(--accent-green); font-weight: bold;">
                                <i class="fas fa-check-circle"></i> {% trans "À jour" %}
                            </span>
                        {% else %}
                            <span style="color: var(--accent-red); font-weight: bold;">
                                <i class="fas fa-times-circle"></i> {% trans "Non à jour" %}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Historique des dons -->
            {% if capability.can_view_donations %}
                <div class="auth-card-secondary">
                    <div class="flex-between">
                        <h4>{% trans "Historique des dons" %}</h4>
                        {% if capability.can_add_donations %}
                            <a href="{% url 'ui:donation_create' %}?customer_id={{ customer.pk }}"
                               class="auth-button"
                               style="width: auto; padding: 8px 15px;">
                                <i class="fas fa-plus"></i> {% trans "Ajouter" %}
                            </a>
                        {% endif %}
                    </div>
                    {% if donations %}
                        <div class="users-table">
                            <table>
                                <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Montant" %}</th>
                                    <th>{% trans "Adhésion" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for donation in donations %}
                                    <tr>
                                        <td>{{ donation.date|date:"d/m/Y" }}</td>
                                        <td>{{ donation.amount|floatformat:2 }} €</td>
                                        <td class="table-cell-center">
                                            {% if donation.includes_membership %}
                                                <i class="fas fa-check-circle"
                                                   style="color: var(--accent-green);"></i>
                                            {% else %}
                                                <i class="fas fa-times-circle"
                                                   style="color: var(--accent-red);"></i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="actions-buttons">
                                                {% if capability.can_edit_donations %}
                                                    <a href="{% url 'ui:donation_update' donation.pk %}"
                                                       class="action-button"
                                                       title="{% trans 'Editer' %}">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center">{% trans "Aucun don enregistré" %}</p>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Historique des réservations -->
            <div class="auth-card-secondary">
                <div class="flex-between">
                    <h4>{% trans "Historique des réservations" %}</h4>
                    {% if capability.can_add_reservations %}
                        <a href="{% url 'ui:reservation_create' %}?customer_id={{ customer.pk }}"
                           class="auth-button"
                           style="width: auto; padding: 8px 15px;">
                            <i class="fas fa-plus"></i> {% trans "Ajouter" %}
                        </a>
                    {% endif %}
                </div>
                {% if reservations %}
                    <div class="users-table">
                        <table>
                            <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Événement" %}</th>
                                <th>{% trans "Statut" %}</th>
                                <th>{% trans "Actions" %}</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for reservation in reservations %}
                                <tr>
                                    <td>{{ reservation.checkout_date|date:"d/m/Y" }}</td>
                                    <td>{{ reservation.event_name }}</td>
                                    <td>
                                        <span class="badge-status badge-{{ reservation.status }}">
                                            {{ reservation.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="actions-buttons">
                                            {% if capability.can_view_reservations %}
                                                <a href="{% url 'ui:reservation_detail' reservation.pk %}"
                                                   class="action-button"
                                                   title="{% trans 'Voir détails' %}">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center">{% trans "Aucune réservation enregistrée" %}</p>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="reservation-footer-actions">
                <a href="javascript:history.back()" class="auth-button secondary">
                    <i class="fas fa-arrow-left"></i> {% trans "Retour" %}
                </a>
                {% if capability.can_edit_customers %}
                    <a href="{% url 'ui:customer_update' customer.pk %}" class="auth-button">
                        <i class="fas fa-edit"></i> {% trans "Modifier" %}
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
