{% extends 'base.html' %}
{% load i18n %}

{% block content %}
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-users-cog auth-icon"></i>
                <h2>{% trans "Gestion des Clients" %}</h2>
            </div>

            <!-- Barre de recherche et boutons d'action sur la même ligne -->
            <div class="search-action-bar">
                <form method="get" class="search-container">
                    <div class="search-input-group">
                        <input type="text" name="search" value="{{ search_query }}"
                               placeholder="{% trans 'Rechercher un client...' %}" class="search-input">
                        <button type="submit" class="auth-button search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <input type="hidden" name="customer_type" value="{{ customer_type_id }}">
                    <input type="hidden" name="entity_type" value="{{ entity_type }}">
                    <input type="hidden" name="donation_exemption" value="{{ donation_exemption }}">
                    <input type="hidden" name="sort" value="{{ sort }}">
                    <input type="hidden" name="direction" value="{{ direction }}">
                </form>

                <div class="actions-buttons">
                    {% if capability.can_add_customers %}
                        <a href="{% url 'ui:customer_type_list' %}" class="auth-button"
                           title="{% trans 'Types de clients' %}">
                            <i class="fas fa-users-cog"></i>
                        </a>
                        <a href="{% url 'ui:customer_create' %}" class="auth-button"
                           title="{% trans "Ajouter un client" %}">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Ligne de filtres -->
            <div class="filters-row">

                <!-- Filtre par type de client -->
                <div class="filter-group">
                    <div class="filter-label">
                        <i class="fas fa-users"></i> {% trans "Type de client" %}:
                    </div>
                    <div class="filter-options">
                        <select id="customer-type-select" class="filter-select">
                            <option value=""
                                    {% if not customer_type_id %}selected{% endif %}>{% trans "Tous" %}</option>
                            {% for type in customer_types %}
                                <option value="{{ type.id }}"
                                        {% if customer_type_id|stringformat:'s' == type.id|stringformat:'s' %}selected{% endif %}>
                                    {{ type.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Filtre par type d'entité -->
                    <div class="filter-buttons-container">
                        <a href="{% url 'ui:customers' %}"
                           class="filter-button {% if not entity_type %}active{% endif %}">
                            <i class="fas fa-users"></i> {% trans "Tous" %}
                        </a>
                        <a href="{% url 'ui:customers' %}?entity_type=physical{% if search_query %}&search={{ search_query }}{% endif %}{% if customer_type_id %}&customer_type={{ customer_type_id }}{% endif %}{% if donation_exemption %}&donation_exemption={{ donation_exemption }}{% endif %}"
                           class="filter-button {% if entity_type == 'physical' %}active{% endif %}">
                            <i class="fas fa-user"></i> {% trans "Particuliers" %}
                        </a>
                        <a href="{% url 'ui:customers' %}?entity_type=legal{% if search_query %}&search={{ search_query }}{% endif %}{% if customer_type_id %}&customer_type={{ customer_type_id }}{% endif %}{% if donation_exemption %}&donation_exemption={{ donation_exemption }}{% endif %}"
                           class="filter-button {% if entity_type == 'legal' %}active{% endif %}">
                            <i class="fas fa-building"></i> {% trans "Structures" %}
                        </a>
                    </div>
                </div>

                <!-- Filtre par exonération -->
                <div class="filter-group">
                    <div class="filter-label">
                        <i class="fas fa-hand-holding-usd"></i> {% trans "Donateur" %}:
                    </div>
                    <div class="filter-buttons-container">
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if not donation_exemption %}active{% endif %}">
                            {% trans "Tous" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}donation_exemption=false&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if donation_exemption == 'false' %}active{% endif %}">
                            <i class="fas fa-coins"></i> {% trans "Avec don" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}donation_exemption=true&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if donation_exemption == 'true' %}active{% endif %}">
                            <i class="fas fa-hand-holding-usd"></i> {% trans "Exonéré" %}
                        </a>
                    </div>
                </div>
            </div>


            <!-- Liste des clients -->
            <div class="users-table">
                <table>
                    <thead>
                    <tr>
                        <th>{% trans "Type" %}
                            <div class="sort-buttons">
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}{% if donation_exemption %}donation_exemption={{ donation_exemption }}&{% endif %}sort=type&direction=asc"
                                   class="sort-btn {% if sort == 'type' and direction == 'asc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down"></i>
                                </a>
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}{% if donation_exemption %}donation_exemption={{ donation_exemption }}&{% endif %}sort=type&direction=desc"
                                   class="sort-btn {% if sort == 'type' and direction == 'desc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down-alt"></i>
                                </a>
                            </div>
                        </th>
                        <th>
                            {% trans "Informations client" %}
                            <div class="sort-buttons">
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}{% if donation_exemption %}donation_exemption={{ donation_exemption }}&{% endif %}sort=name&direction=asc"
                                   class="sort-btn {% if sort == 'name' and direction == 'asc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down"></i>
                                </a>
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if entity_type %}entity_type={{ entity_type }}&{% endif %}{% if customer_type_id %}customer_type_id={{ customer_type_id }}&{% endif %}{% if donation_exemption %}donation_exemption={{ donation_exemption }}&{% endif %}sort=name&direction=desc"
                                   class="sort-btn {% if sort == 'name' and direction == 'desc' %}active{% endif %}">
                                    <i class="fas fa-sort-alpha-down-alt"></i>
                                </a>
                            </div>
                        </th>
                        <th>{% trans "Contact" %}</th>
                        <th class="table-cell-center">{% trans "Cotisation" %}</th>
                        <th class="table-cell-center">{% trans "Actions" %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for customer in customers %}
                        <tr>
                            <td class="customer-type-icon">
                                {% if customer.is_exempted_from_donation %}
                                    <span class="badge-exemption" title="{% trans 'Exonération de don' %}">
                                            <i class="fas fa-hand-holding-usd"></i>
                                        </span>
                                {% endif %}
                                <i class=
                                           {% if customer.customer_type.entity_type == "physical" %}
                                               "fas fa-user"
                                           {% else %}
                                               "fas fa-building"
                                           {% endif %}
                                style="color: {{ customer.customer_type.color }}"
                                title="{{ customer.customer_type.name }}"></i>

                            </td>
                            <td>
                                <div class="customer-info">
                                    {% if customer.customer_type.entity_type == "physical" %}
                                        <span class="customer-name">{{ customer.last_name }} {{ customer.first_name }}</span>
                                    {% else %}
                                        <span class="customer-name">{{ customer.company_name }}</span>
                                        <span class="customer-subtitle">
                                                <i class="fas fa-user-tie"></i> {{ customer.legal_rep_last_name }} {{ customer.legal_rep_first_name }}
                                            </span>
                                    {% endif %}

                                    <span class="customer-address">
                                            <i class="fas fa-map-marker-alt"></i> {{ customer.address|truncatewords:6 }}
                                        </span>
                                </div>
                            </td>
                            <td>
                                <div class="contact-info">
                                    <div class="values-container">
                                        {% if customer.email %}
                                            <span class="value-item">
                                            <i class="fas fa-envelope"></i>
                                            <a href="mailto:{{ customer.email }}"
                                               class="email-link">{{ customer.email }}</a>
                                        </span>
                                        {% endif %}
                                        {% if customer.phone %}
                                            <div>
                                                <i class="fas fa-phone"></i> {{ customer.phone }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="table-cell-center">
                                {% if customer.is_membership_up_to_date %}
                                    <i class="fas fa-check-circle"
                                       style="color: var(--accent-green); font-size: 1.2rem;"
                                       title="{% trans 'À jour' %}"></i>
                                {% else %}
                                    <i class="fas fa-times-circle" style="color: var(--accent-red); font-size: 1.2rem;"
                                       title="{% trans 'Non à jour' %}"></i>
                                {% endif %}
                            </td>
                            <td>
                                <div class="actions-buttons">
                                    {% if capability.can_view_customers %}
                                        <a href="{% url 'ui:customer_detail' customer.pk %}" class="action-button"
                                           title="{% trans 'Voir détails' %}">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                    {% if capability.can_edit_customers %}
                                        <a href="{% url 'ui:customer_update' customer.id %}" class="action-button"
                                           title="{% trans 'Modifier' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    {% endif %}
                                    {% if capability.can_delete_customers %}
                                        <a href="{% url 'ui:customer_delete' customer.id %}"
                                           class="action-button danger" title="{% trans 'Supprimer' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                <i class="fas fa-search"
                                   style="font-size: 2rem; margin-bottom: 15px; color: var(--text-secondary);"></i>
                                <p>{% trans "Aucun client trouvé" %}</p>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const customerTypeSelect = document.getElementById('customer-type-select');
            const entityTypeFilter = document.querySelector('.filter-buttons-container');

            // Fonction pour gérer l'affichage du filtre par type d'entité
            function toggleEntityTypeFilter() {
                if (customerTypeSelect.value === '') {
                    // Afficher le filtre d'entité si "Tous" est sélectionné
                    entityTypeFilter.style.display = 'flex';
                } else {
                    // Masquer le filtre d'entité si un type spécifique est sélectionné
                    entityTypeFilter.style.display = 'none';
                }
            }

            // Appliquer immédiatement pour l'état initial
            toggleEntityTypeFilter();

            // Rediriger vers la bonne URL lorsqu'une option est sélectionnée
            customerTypeSelect.addEventListener('change', function () {
                let url = new URL(window.location);

                // Mettre à jour le paramètre customer_type
                if (this.value) {
                    url.searchParams.set('customer_type', this.value);
                    // Réinitialiser le filtre d'entité si un type spécifique est sélectionné
                    url.searchParams.delete('entity_type');
                } else {
                    url.searchParams.delete('customer_type');
                    // Conserver le filtre d'entité actuel
                }

                // Rediriger vers la nouvelle URL
                window.location.href = url.toString();
            });
        });
    </script>
{% endblock %}
