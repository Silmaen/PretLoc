{% extends 'base.html' %}
{% load i18n %}

{% block content %}
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-users-cog auth-icon"></i>
                <h2>{% trans "Gestion des Clients" %}</h2>
            </div>

            <!-- Barre de recherche et boutons d'action sur la même ligne -->
            <div class="search-action-bar">
                <form method="get" class="search-container">
                    <div class="search-input-group">
                        <input type="text" name="search" value="{{ search_query }}"
                               placeholder="{% trans 'Rechercher un client...' %}" class="search-input">
                        <button type="submit" class="auth-button search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <input type="hidden" name="type" value="{{ customer_type }}">
                    <input type="hidden" name="sort" value="{{ sort }}">
                    <input type="hidden" name="direction" value="{{ direction }}">
                </form>

                <div class="actions-buttons">
                    {% if capability.can_add_customers %}
                        <a href="{% url 'ui:customer_create' %}" class="auth-button">
                            <i class="fas fa-plus"></i> {% trans "Ajouter un client" %}
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Ligne de filtres -->
            <div class="filters-row">
                <div class="filter-group">
                    <div class="filter-label">
                        <i class="fas fa-filter"></i> {% trans "Type:" %}
                    </div>
                    <div class="filter-buttons-container">
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if not customer_type %}active{% endif %}">
                            {% trans "Tous" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=member&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'member' %}active{% endif %}">
                            <i class="fas fa-user-tie"></i> {% trans "Membres" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=physical&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'physical' %}active{% endif %}">
                            <i class="fas fa-user"></i> {% trans "Pers. Genay" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=phys_ext&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'phys_ext' %}active{% endif %}">
                            <i class="fas fa-user-friends"></i> {% trans "Pers. extérieures" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=legal&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'legal' %}active{% endif %}">
                            <i class="fas fa-building"></i> {% trans "Sociétés Genay" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=legal_ext&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'legal_ext' %}active{% endif %}">
                            <i class="fas fa-city"></i> {% trans "Sociétés ext." %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=asso&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'asso' %}active{% endif %}">
                            <i class="fas fa-hands-helping"></i> {% trans "Assos Genay" %}
                        </a>
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}type=asso_ext&sort={{ sort }}&direction={{ direction }}"
                           class="filter-button {% if customer_type == 'asso_ext' %}active{% endif %}">
                            <i class="fas fa-handshake"></i> {% trans "Assos ext." %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- Liste des clients -->
            <div class="users-table">
                <table>
                    <thead>
                        <tr>
                            <th>{% trans "Type" %}</th>
                            <th>{% trans "Informations client" %}</th>
                            <th>{% trans "Contact" %}</th>
                            <th>{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                            <tr>
                                <td class="customer-type-icon">
                                    {% if customer.donation_exemption %}
                                        <span class="badge-exemption" title="{% trans 'Exonération de don' %}">
                                            <i class="fas fa-hand-holding-usd"></i>
                                        </span>
                                    {% endif %}
                                    <i class=
                                               {% if customer.customer_type.entity_type == "physical" %}
                                                   "fas fa-user"
                                               {% else %}
                                                   "fas fa-building"
                                               {% endif %}
                                       style="color: {{ customer.customer_type.color }}"
                                       title="{{ customer.customer_type.name }}"></i>

                                </td>
                                <td>
                                    <div class="customer-info">
                                        {% if customer.customer_type.entity_type == "physical" %}
                                            <span class="customer-name">{{ customer.last_name }} {{ customer.first_name }}</span>
                                        {% else %}
                                            <span class="customer-name">{{ customer.company_name }}</span>
                                            <span class="customer-subtitle">
                                                <i class="fas fa-user-tie"></i> {{ customer.legal_rep_last_name }} {{ customer.legal_rep_first_name }}
                                            </span>
                                        {% endif %}

                                        <span class="customer-address">
                                            <i class="fas fa-map-marker-alt"></i> {{ customer.address|truncatewords:6 }}
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <div class="contact-info">
                                        <div title="{% trans 'Envoyer un mail' %}">
                                            <i class="fas fa-envelope"></i>
                                            <a href="mailto:{{ customer.email }}"
                                               class="email-link">{{ customer.email }}</a>
                                        </div>
                                        {% if customer.phone %}
                                            <div>
                                                <i class="fas fa-phone"></i> {{ customer.phone }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="actions-buttons">
                                        {% if capability.can_edit_customers %}
                                            <a href="{% url 'ui:customer_update' customer.id %}" class="action-button"
                                               title="{% trans 'Modifier' %}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                        {% if capability.can_delete_customers %}
                                            <a href="{% url 'ui:customer_delete' customer.id %}"
                                               class="action-button danger" title="{% trans 'Supprimer' %}">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px;">
                                    <i class="fas fa-search"
                                       style="font-size: 2rem; margin-bottom: 15px; color: var(--text-secondary);"></i>
                                    <p>{% trans "Aucun client trouvé" %}</p>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}
